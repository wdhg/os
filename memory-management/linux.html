<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Linux Virtual Memory - Operating Systems</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../preface.html"><strong aria-hidden="true">1.</strong> Preface</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../processes.html"><strong aria-hidden="true">3.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/unix.html"><strong aria-hidden="true">3.1.</strong> UNIX Processes</a></li><li class="chapter-item expanded "><a href="../processes/windows.html"><strong aria-hidden="true">3.2.</strong> Windows Processes</a></li><li class="chapter-item expanded "><a href="../processes/communication.html"><strong aria-hidden="true">3.3.</strong> Process Communication</a></li></ol></li><li class="chapter-item expanded "><a href="../threads.html"><strong aria-hidden="true">4.</strong> Threads</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threads/posix.html"><strong aria-hidden="true">4.1.</strong> PThreads (POSIX Threads)</a></li><li class="chapter-item expanded "><a href="../threads/user-kernel.html"><strong aria-hidden="true">4.2.</strong> User-Level and Kernel-Level Threads</a></li></ol></li><li class="chapter-item expanded "><a href="../scheduling.html"><strong aria-hidden="true">5.</strong> Scheduling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../scheduling/fcfs.html"><strong aria-hidden="true">5.1.</strong> First-Come First-Served</a></li><li class="chapter-item expanded "><a href="../scheduling/rr.html"><strong aria-hidden="true">5.2.</strong> Round-Robin</a></li><li class="chapter-item expanded "><a href="../scheduling/sjf-srt.html"><strong aria-hidden="true">5.3.</strong> Shortest Job First and Shortest Remaining Time</a></li><li class="chapter-item expanded "><a href="../scheduling/fs.html"><strong aria-hidden="true">5.4.</strong> Fair-Share Scheduling</a></li><li class="chapter-item expanded "><a href="../scheduling/priority.html"><strong aria-hidden="true">5.5.</strong> Priority Scheduling</a></li><li class="chapter-item expanded "><a href="../scheduling/mlfqs.html"><strong aria-hidden="true">5.6.</strong> Multilevel Feedback Queues (MLFQS)</a></li><li class="chapter-item expanded "><a href="../scheduling/lottery.html"><strong aria-hidden="true">5.7.</strong> Lottery Scheduling</a></li></ol></li><li class="chapter-item expanded "><a href="../synchronisation.html"><strong aria-hidden="true">6.</strong> Synchronisation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../synchronisation/mutual-exclusion.html"><strong aria-hidden="true">6.1.</strong> Attempts at Gaining Mutual Exclusion</a></li><li class="chapter-item expanded "><a href="../synchronisation/atomics.html"><strong aria-hidden="true">6.2.</strong> Atomic Operations</a></li><li class="chapter-item expanded "><a href="../synchronisation/locks.html"><strong aria-hidden="true">6.3.</strong> Locks</a></li><li class="chapter-item expanded "><a href="../synchronisation/race-conditions.html"><strong aria-hidden="true">6.4.</strong> Race Conditions and Memory Models</a></li><li class="chapter-item expanded "><a href="../synchronisation/semaphores.html"><strong aria-hidden="true">6.5.</strong> Semaphores</a></li><li class="chapter-item expanded "><a href="../synchronisation/monitors.html"><strong aria-hidden="true">6.6.</strong> Monitors</a></li><li class="chapter-item expanded "><a href="../synchronisation/deadlocks.html"><strong aria-hidden="true">6.7.</strong> Deadlocks</a></li></ol></li><li class="chapter-item expanded "><a href="../memory-management.html"><strong aria-hidden="true">7.</strong> Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory-management/logical-physical.html"><strong aria-hidden="true">7.1.</strong> Logical vs. Physical Address Space</a></li><li class="chapter-item expanded "><a href="../memory-management/allocation-and-protection.html"><strong aria-hidden="true">7.2.</strong> Allocation and Protection</a></li><li class="chapter-item expanded "><a href="../memory-management/virtual-memory.html"><strong aria-hidden="true">7.3.</strong> Virtual Memory with Paging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory-management/virtual-memory/paging.html"><strong aria-hidden="true">7.3.1.</strong> Paging</a></li><li class="chapter-item expanded "><a href="../memory-management/virtual-memory/segmentation.html"><strong aria-hidden="true">7.3.2.</strong> Segmentation</a></li></ol></li><li class="chapter-item expanded "><a href="../memory-management/linux.html" class="active"><strong aria-hidden="true">7.4.</strong> Linux Virtual Memory</a></li><li class="chapter-item expanded "><a href="../memory-management/demand-paging.html"><strong aria-hidden="true">7.5.</strong> Demand Paging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory-management/demand-paging/cow-mmap.html"><strong aria-hidden="true">7.5.1.</strong> Copy-on-Write (COW) and Memory Mapped Files</a></li><li class="chapter-item expanded "><a href="../memory-management/demand-paging/page-replacement.html"><strong aria-hidden="true">7.5.2.</strong> Page Replacement</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../device-management.html"><strong aria-hidden="true">8.</strong> Device Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../device-management/io-layering.html"><strong aria-hidden="true">8.1.</strong> I/O Layering</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../device-management/io-layering/interrupt-handler.html"><strong aria-hidden="true">8.1.1.</strong> Interrupt Handler Layer</a></li><li class="chapter-item expanded "><a href="../device-management/io-layering/device-driver.html"><strong aria-hidden="true">8.1.2.</strong> Device Driver Layer</a></li><li class="chapter-item expanded "><a href="../device-management/io-layering/device-independent-os-software.html"><strong aria-hidden="true">8.1.3.</strong> Device Independent OS Software Layer</a></li><li class="chapter-item expanded "><a href="../device-management/io-layering/user-level-io-interface.html"><strong aria-hidden="true">8.1.4.</strong> User-Level I/O Interface Layer</a></li></ol></li><li class="chapter-item expanded "><a href="../device-management/device-drivers.html"><strong aria-hidden="true">8.2.</strong> Device Drivers</a></li><li class="chapter-item expanded "><a href="../device-management/blocking-vs-non-blocking-io.html"><strong aria-hidden="true">8.3.</strong> Blocking vs. Non-Blocking I/O</a></li><li class="chapter-item expanded "><a href="../device-management/linux-io-api.html"><strong aria-hidden="true">8.4.</strong> Linux I/O API</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Operating Systems</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="linux-virtual-memory"><a class="header" href="#linux-virtual-memory">Linux Virtual Memory</a></h1>
<h2 id="linux-virtual-memory-layout"><a class="header" href="#linux-virtual-memory-layout">Linux Virtual Memory Layout</a></h2>
<p>On 32-bit architecture, processes in linux have a virtual address space of 4GB.</p>
<pre><code>         0                     896MB
         *-----*-*---------------*---------------------*
  Main   | DMA | |    Normal    |         High         |
  Memory |     | |    Memory    |        Memory        |
         *-----*-*---------------*---------------------*
          \     \ \               \
           \     \ \ The nth page  \
            \     \ \ of the kernel \
             \     \ \ address space \
              \     \ \ maps to the   \
               \     \ \ nth page      \
                \     \ \ frame of main \
                 \     \ \ memory.       \
                  \     \ \               \
                   \     \ \               \
          *---------*-----*-*---------------*-----------*
  Virtual |  User   |     | |               | On-demand |
  memory  | Process |     | |               | mapping   |
          *---------*-----*-*---------------*-----------*
          0        3GB                                 4GB
                    |---------896MB---------|
                    |-------Kernel address space--------|

</code></pre>
<p>In this diagram:</p>
<ul>
<li>The bottom diagram is the &quot;view&quot; that an executing user process would have of its virtual address space.</li>
<li>The first 3 gigabytes in the virtual memory is where the code, stack, and heap are allocated normally.</li>
<li>Processes map the kernel to the 3-4GB virtual address range, which allows user processes to make system calls without a TLB flush (efficient).</li>
<li>The kernel maps the lower 896MB of physical memory to its virtual address space.</li>
</ul>
<h2 id="paging"><a class="header" href="#paging">Paging</a></h2>
<ul>
<li>On x86-32 (IA-32) linux uses:
<ul>
<li>a 4KB page size</li>
<li>a 4GB virtual address space</li>
<li>typically a two-level page table.</li>
</ul>
</li>
<li>On x86-64 linux uses
<ul>
<li>a larger page sizes (e.g. 4MB)</li>
<li>up to a four-level page table.</li>
</ul>
</li>
</ul>
<p>The two-level page table (which can be replaced with a three-level page table with Physical Address Extension (PAE)) uses the offset bits in the addresses to store the page status (dirty, read-only, etc).</p>
<p>x86 has a particular terminology for the levels of the page table</p>
<ul>
<li><strong>Page global directory</strong>: the outer page table.</li>
<li><strong>Page table</strong>: the inner page tables.</li>
</ul>
<p><strong>TODO DRAW DIAGRAM</strong></p>
<h2 id="meltdown-attack"><a class="header" href="#meltdown-attack">Meltdown Attack</a></h2>
<p>Meltdown is an attack that allows a user program to access the kernel address space mapped in its virtual memory, bypassing the page protection that only allows access to this memory in privileged mode.</p>
<pre><code class="language-c">s = a + b;
t = s + c;
u = t + d;
v = u + e;

if (v == 0) {
  w = kernel_mem[addr]; // illegal access, will page fault
  // the following is not run
  x = w &amp; 0x01;
  y = x * 4096;
  z = user_mem[y];
}
</code></pre>
<p>The code above should not run after the page fault, however due to <strong>speculative execution</strong> this is not the case.</p>
<h3 id="speculative-execution"><a class="header" href="#speculative-execution">Speculative Execution</a></h3>
<p><strong>Speculative execution</strong> is an optimization technique where a computer will execute some code concurrently before knowing if it is needed or not. The relevent use case of speculative execution for the meltdown attack is <strong>branch prediction</strong>.</p>
<p>The CPU figures out that it can run the code outside the if block and inside the if block concurrently, as there is no data dependency between them. However, the effects of speculative execution cannot be made visible (e.g. through updating memory or register contents directly) as it is unknown whether or not the branch will be taken yet. Therefore, the results are hidden in intermediate variables <code>w_</code>, <code>x_</code>, <code>y_</code>, and <code>z_</code>.</p>
<pre><code class="language-c">/* the branch predictor thinks the v == 0 branch will,
 * so it speculatively executes it
 */
w_ = kernel_mem[addr];
x_ = w &amp; 0x01;
y_ = x * 4096;
z_ = user_mem[y_];
</code></pre>
<pre><code class="language-c">s = a + b;
t = s + c;
u = t + d;
v = u + e;

if (v == 0) {
  // assign hidden values
  w = w_; x = x_; y = y_; z = z_;
}
</code></pre>
<p>When the speculative execution runs the code, it will be an illegal access but it cannot fault yet as the effects cannot be made visible yet (the protection level could change by the time the branch is reached). Therefore it continues executing. If <code>v == 0</code>, then the fault will occur and <code>w = w_; x = x_; y = y_; z = z_;</code> won't run.</p>
<p>At first, CPU manufacturers (e.g. Intel) thought this was safe as the protected kernel memory was never revealed.</p>
<p>Going over the speculatively executed code:</p>
<pre><code class="language-c">w_ = kernel_mem[addr]; // retrieve data from kernel memory
x_ = w &amp; 0x01;         // mask out 1 bit from this data. x_ = 0 or x_ = 1
y_ = x * 4096;         // multiply. y_ = 0 or y_ = 4096
z_ = user_mem[y_];     // access user memory at either index 0 or 4096
</code></pre>
<p>By initially arranging that <code>user_mem[0..4096]</code> is not cached, the access <code>user_mem[y_]</code> will cause either <code>user_mem[0]</code> or <code>user_mem[4096]</code> to be in cache after being speculatively executed. A program then can time how long it takes to access <code>user_mem[0]</code> and <code>user_mem[4096]</code>. If <code>user_mem[0]</code> is significantly faster then it must be in cache so <code>x_</code> was a <code>0</code>, otherwise if <code>user_mem[4096]</code> is significantly faster then <code>x_</code> was <code>1</code>. Thus the program has learned the value of a single bit in kernel memory.</p>
<p>Generalising this attack to read many bits could allow a program to leak larger amounts of memory from the kernel. In practice this attack is quite effective, allowing for a program to leak arbitrary amounts of kernel memory, which could include the root password.</p>
<h3 id="the-fix"><a class="header" href="#the-fix">The Fix</a></h3>
<p>Recent versions of Linux fix this by moving kernel memory to a separate virtual address space. This makes system calls more expensive, but it prevents any program from executing this attack.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../memory-management/virtual-memory/segmentation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../memory-management/demand-paging.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../memory-management/virtual-memory/segmentation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../memory-management/demand-paging.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
