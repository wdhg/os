<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Deadlocks - Operating Systems</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../preface.html"><strong aria-hidden="true">1.</strong> Preface</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../processes.html"><strong aria-hidden="true">3.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes/unix.html"><strong aria-hidden="true">3.1.</strong> UNIX Processes</a></li><li class="chapter-item expanded "><a href="../processes/windows.html"><strong aria-hidden="true">3.2.</strong> Windows Processes</a></li><li class="chapter-item expanded "><a href="../processes/communication.html"><strong aria-hidden="true">3.3.</strong> Process Communication</a></li></ol></li><li class="chapter-item expanded "><a href="../threads.html"><strong aria-hidden="true">4.</strong> Threads</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threads/posix.html"><strong aria-hidden="true">4.1.</strong> PThreads (POSIX Threads)</a></li><li class="chapter-item expanded "><a href="../threads/user-kernel.html"><strong aria-hidden="true">4.2.</strong> User-Level and Kernel-Level Threads</a></li></ol></li><li class="chapter-item expanded "><a href="../scheduling.html"><strong aria-hidden="true">5.</strong> Scheduling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../scheduling/fcfs.html"><strong aria-hidden="true">5.1.</strong> First-Come First-Served</a></li><li class="chapter-item expanded "><a href="../scheduling/rr.html"><strong aria-hidden="true">5.2.</strong> Round-Robin</a></li><li class="chapter-item expanded "><a href="../scheduling/sjf-srt.html"><strong aria-hidden="true">5.3.</strong> Shortest Job First and Shortest Remaining Time</a></li><li class="chapter-item expanded "><a href="../scheduling/fs.html"><strong aria-hidden="true">5.4.</strong> Fair-Share Scheduling</a></li><li class="chapter-item expanded "><a href="../scheduling/priority.html"><strong aria-hidden="true">5.5.</strong> Priority Scheduling</a></li><li class="chapter-item expanded "><a href="../scheduling/mlfqs.html"><strong aria-hidden="true">5.6.</strong> Multilevel Feedback Queues (MLFQS)</a></li><li class="chapter-item expanded "><a href="../scheduling/lottery.html"><strong aria-hidden="true">5.7.</strong> Lottery Scheduling</a></li></ol></li><li class="chapter-item expanded "><a href="../synchronisation.html"><strong aria-hidden="true">6.</strong> Synchronisation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../synchronisation/mutual-exclusion.html"><strong aria-hidden="true">6.1.</strong> Attempts at Gaining Mutual Exclusion</a></li><li class="chapter-item expanded "><a href="../synchronisation/atomics.html"><strong aria-hidden="true">6.2.</strong> Atomic Operations</a></li><li class="chapter-item expanded "><a href="../synchronisation/locks.html"><strong aria-hidden="true">6.3.</strong> Locks</a></li><li class="chapter-item expanded "><a href="../synchronisation/race-conditions.html"><strong aria-hidden="true">6.4.</strong> Race Conditions and Memory Models</a></li><li class="chapter-item expanded "><a href="../synchronisation/semaphores.html"><strong aria-hidden="true">6.5.</strong> Semaphores</a></li><li class="chapter-item expanded "><a href="../synchronisation/monitors.html"><strong aria-hidden="true">6.6.</strong> Monitors</a></li><li class="chapter-item expanded "><a href="../synchronisation/deadlocks.html" class="active"><strong aria-hidden="true">6.7.</strong> Deadlocks</a></li></ol></li><li class="chapter-item expanded "><a href="../memory-management.html"><strong aria-hidden="true">7.</strong> Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory-management/logical-physical.html"><strong aria-hidden="true">7.1.</strong> Logical vs. Physical Address Space</a></li><li class="chapter-item expanded "><a href="../memory-management/allocation-and-protection.html"><strong aria-hidden="true">7.2.</strong> Allocation and Protection</a></li><li class="chapter-item expanded "><a href="../memory-management/virtual-memory.html"><strong aria-hidden="true">7.3.</strong> Virtual Memory with Paging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory-management/virtual-memory/paging.html"><strong aria-hidden="true">7.3.1.</strong> Paging</a></li><li class="chapter-item expanded "><a href="../memory-management/virtual-memory/segmentation.html"><strong aria-hidden="true">7.3.2.</strong> Segmentation</a></li></ol></li><li class="chapter-item expanded "><a href="../memory-management/linux.html"><strong aria-hidden="true">7.4.</strong> Linux Virtual Memory</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Operating Systems</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="deadlocks"><a class="header" href="#deadlocks">Deadlocks</a></h1>
<p>A deadlock is a state where multiple processes are waiting for an event that only another waiting process can cause.</p>
<p>A resource deadlock is the most common type of deadlock, and it has 4 conditions that must hold for it to occur: </p>
<ul>
<li><strong>Mutual Exclusion</strong>: each resource is either available or assigned to exactly one process.</li>
<li><strong>Hold and Wait</strong>: a process can request resources whilst it holds another resource which it has previously requested.</li>
<li><strong>No Preemption</strong>: resources given to a process cannot be foricbly revoked.</li>
<li><strong>Circular Wait</strong>: two or more processes in a circular chain where each process is waiting for a resource held by the next process.</li>
</ul>
<h2 id="resource-allocation-graphs"><a class="header" href="#resource-allocation-graphs">Resource Allocation Graphs</a></h2>
<p>Using a directed graph, resource allocation can be modelled:</p>
<ul>
<li>a directed edge from a resource to process means the process currently owns that resource.</li>
<li>a directed edge from a process to a resource means the process is blocked and waiting for that resource.</li>
</ul>
<p>If a cycle appears in the graph, then there is a deadlock.</p>
<h2 id="strategies-for-dealing-with-deadlocks"><a class="header" href="#strategies-for-dealing-with-deadlocks">Strategies for Dealing with Deadlocks</a></h2>
<ul>
<li><strong>Ignore It</strong>:
<ul>
<li>Also known as &quot;The Ostrich Algorithm&quot;.</li>
<li>If contention for resources is low, then the number of deadlocks is infrequent, so ignoring the problem may be okay given how rare it can be.</li>
</ul>
</li>
<li><strong>Detection and Recovery</strong>:
<ul>
<li>After a system is deadlocked:
<ol>
<li>Detect the deadlock.</li>
<li>Recover from the deadlock.</li>
</ol>
</li>
</ul>
</li>
<li><strong>Dynamic Avoidance</strong>:
<ul>
<li>Dynamically consider every request and consider whether it is safe to grant it.</li>
<li>Requires information regarding potential resource use.</li>
</ul>
</li>
<li><strong>Prevention</strong>:
<ul>
<li>Prevent deadlocks by ensuring at least one of the four deadlock contentions can never hold.</li>
</ul>
</li>
</ul>
<h2 id="detection-and-recovery"><a class="header" href="#detection-and-recovery">Detection and Recovery</a></h2>
<p>Detection and Recovery works by building a resource allocation graph and searches for cycles.</p>
<h3 id="detection"><a class="header" href="#detection">Detection</a></h3>
<p>At a high level, the algorithm simply performs depth-first search over each node (resource / process) in the graph. At each node, it checks for any cycles. The algorithm is as follows:</p>
<ol>
<li>For each node (resource / process) do:</li>
<li>Initialise variable <code>L</code> to the empty list.</li>
<li>Check if the current node exists in <code>L</code> already. If yes then there is a cycle and the algorithm can exit, otherwise continue to 4.</li>
<li>From the current node, check for any unmarked outgoing edge. If there is one, goto 5, otherwise goto 6.</li>
<li>Pick the unmarked edge, mark it so it isn't inspected again, and follow it to the next node. Goto 3 with this node.</li>
<li>If this node is the initial node then no cycles are detected and the algorithm can exit. Otherwise, the search has reached a dead end, so remove it from <code>L</code>, set the previous node to the current node, and goto 3.</li>
</ol>
<h3 id="recovery"><a class="header" href="#recovery">Recovery</a></h3>
<p>There are three potential techniques for recovering:</p>
<ul>
<li><strong>Pre-emption</strong>: temporarily take resources from the owner process and give it to the waiting process. This only works in certain conditions as if that process is using the resource then giving it to another state might corrupt its state.</li>
<li><strong>Rollback</strong>: processes are temporarily checkpointed (e.g. by making images of their memory and state), and on a deadlock the process is rolled back to the previous state before the deadlock condition.</li>
<li><strong>Killing Processes</strong>: select a random process in cycle and kill it. The safety of this technique depends significantly on the workload of the process (e.g. may be safe for compile jobs, but not for a database system).</li>
</ul>
<h2 id="dynamic-avoidance"><a class="header" href="#dynamic-avoidance">Dynamic Avoidance</a></h2>
<p>Dynamic Avoidance works by checking each request to see if it will cause a deadlock.</p>
<h3 id="bankers-algorithm-dijkstra-1965"><a class="header" href="#bankers-algorithm-dijkstra-1965">Banker's Algorithm (Dijkstra 1965)</a></h3>
<p>Banker's Algorithm is used to check if a sequence of resource allocations will lead to a <strong>safe state</strong> or not.</p>
<p>A <strong>safe state</strong> is any state where there exists a sequence of allocations that guarantees all customers can be satisfied.</p>
<p>Using the example of a bank:</p>
<ul>
<li>Firstly set-up with a single type of resource.
<ul>
<li>A bank may have N customers, where each customer has maximum credit expressed in a number of credit units (e.g. 1 credit unit = £1000).</li>
</ul>
</li>
<li>Each customer may ask for its maximum credit at some point, use it, and then repay it.</li>
<li>The banker knows that all customers don't need their max credit at the same time, so they can reserve less than the sum of all credit limits.</li>
</ul>
<p>For example, take the following setup:</p>
<pre><code>     Has Max
+---+---+---+   Four customers A, B, C, and D
| A | 0 | 6 |
+---+---+---+   1 credit unit = £1000
| B | 0 | 5 |
+---+---+---+   Banker reserves only 10 (instead of 22) units
| C | 0 | 4 |
+---+---+---+
| D | 0 | 7 |
+---+---+---+
   Free: 10
</code></pre>
<p>A state can be determined to be safe or not by:</p>
<ul>
<li>checking if there are enough resources to satisfy <strong>any</strong> maximum request from some customer.</li>
<li>by assuming that customer pays back their loan, check the next customer closest to the limit, and repeat.</li>
<li>if this results in the state were all loans are paid back (each customer has 0 credit to pay back), then the state is safe.</li>
</ul>
<p>Then consider the following states, one is safe and the other is unsafe:</p>
<pre><code>    SAFE               UNSAFE

     Has Max             Has Max
+---+---+---+       +---+---+---+
| A | 1 | 6 |       | A | 1 | 6 |
+---+---+---+       +---+---+---+
| B | 1 | 5 |       | B | 2 | 5 |
+---+---+---+       +---+---+---+
| C | 2 | 4 |       | C | 2 | 4 |
+---+---+---+       +---+---+---+
| D | 4 | 7 |       | D | 4 | 7 |
+---+---+---+       +---+---+---+
   Free: 2             Free: 1
</code></pre>
<p>The first state is safe as the following sequence of requests can occur:</p>
<ol>
<li>C requests 2 credits (Free: 0).</li>
<li>C pays back 4 credits (Free: 4).</li>
<li>D requests 3 credits (Free: 1).</li>
<li>D pays back 7 credits (Free: 8).</li>
<li>B requests 4 credits (Free: 4).</li>
<li>B pays back 5 credits (Free: 9).</li>
<li>A requests 5 credits (Free: 4).</li>
<li>A pays back 6 credits (Free: 10).</li>
</ol>
<p>With this definition of a safe state, we can then only grant requests that lead to a safe state. This doesn't necessarily mean that an unsafe state will lead to a deadlock, but rather that it cannot be guaranteed that it won't lead to a deadlock.</p>
<p>This algorithm can be generalised to handle multiple resource types.</p>
<h2 id="prevention"><a class="header" href="#prevention">Prevention</a></h2>
<p>Prevention works by preventing any one of the four deadlock conditions: mutual exclusion, hold and wait, no preemption, or circular wait:</p>
<ul>
<li><strong>Attacking the Mutual Exclusion Condition</strong>: for example, by sharing the resources.</li>
<li><strong>Attacking the Hold and Wait Condition</strong>: force all processes to request their resources before starting, and if they aren't all available then wait. This has an issue that the process must know what resources it will need in advance.</li>
<li><strong>Attacking the No Preemption Condition</strong>: by forcing a process to give up their resource. This can be bad in certain situations, such as a stopping a process using an external output device (e.g. a printer) would be bad.</li>
<li><strong>Attacking the Mutual Exclusion Condition</strong>: either by forcing a process to use a single resource (which would cause optimality issues), or by numbering all resources and forcing processes to request resources in the order they are numbered (this is hard as a large number of resources would be difficult to organise).</li>
</ul>
<h2 id="other-types-of-deadlock"><a class="header" href="#other-types-of-deadlock">Other Types of Deadlock</a></h2>
<h3 id="communication-deadlock"><a class="header" href="#communication-deadlock">Communication Deadlock</a></h3>
<p>A <strong>communication deadlock</strong> is specific type of deadlock caused by a poor communication policy. For example:</p>
<ul>
<li>Process A sends a message to process B, but the message is lost in transit.</li>
<li>Process B is blocked whilst it is waiting for this message.</li>
<li>Process A is blocked whilst waiting for a response.</li>
<li>Both processes are blocked waiting for each other, hence it is a deadlock.</li>
</ul>
<p>Ordering of resources or careful scheduling are not useful here. Instead, we can use a communication protocol based on timeouts. In the previous example, A and B would timeout and be able to recover fully.</p>
<h3 id="livelock"><a class="header" href="#livelock">Livelock</a></h3>
<p>A <strong>livelock</strong> is when processes are not blocked, but they or the system as a whole is not making any progress.</p>
<p>For example, constider a system which has two processes where one receives messages and the other processes them. If the processing thread has a lower priority then under high load (i.e. when many messages are being received), the processing thread will never be able to run. This situation is also known as a <strong>receive livelock</strong>, and they are related to <strong>starvation</strong>.</p>
<h3 id="starvation"><a class="header" href="#starvation">Starvation</a></h3>
<p>Starvation is the event where progress is not being made as the system is unable to schedule the required process. Picking the correct scheduling policy is important to prevent certain livelocks.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../synchronisation/monitors.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../memory-management.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../synchronisation/monitors.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../memory-management.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
